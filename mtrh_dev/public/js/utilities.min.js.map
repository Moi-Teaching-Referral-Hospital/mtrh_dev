{"version":3,"file":"utilities.min.js","sources":["../../../../apps/mtrh_dev/mtrh_dev/public/js/utilities.js"],"sourcesContent":["//FOR ALL MTRH DEV JAVASCRIPT UTILITIES\r\n// the following two handles will watch the page changes everywhere\r\n$(window).on('hashchange', page_changed);\r\n$(window).on('load', page_changed);\r\n\r\nfunction page_changed(event) {\r\n    // waiting for page to load completely\r\n    frappe.after_ajax(function () {\r\n        var route = frappe.get_route();\r\n\r\n        if (route[0] == \"Form\") {\r\n            frappe.ui.form.on(route[1], {\r\n                refresh: function (frm) {\r\n                    // if the loaded doc is dirty, don't show workflow buttons\r\n\t\t\t\t\tif (frm.doc.__unsaved===1) {\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvar state_fieldname = frappe.workflow.get_state_fieldname(frm.doctype);\r\n\t\t\t\t\tfunction set_default_state() {\r\n\t\t\t\t\t\tvar default_state = frappe.workflow.get_default_state(frm.doctype, frm.doc.docstatus);\r\n\t\t\t\t\t\tif(default_state) {\r\n\t\t\t\t\t\t\tfrm.set_value(state_fieldname, default_state);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfunction get_state() {\r\n\t\t\t\t\t\t//if(!frm.doc[state_fieldname]) {\r\n\t\t\t\t\t\t//\tset_default_state();\r\n\t\t\t\t\t\t//}\r\n\t\t\t\t\t\treturn frm.doc[state_fieldname];\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst state = get_state();\r\n\t\t\t\t\tif(!state) {\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfunction has_approval_access(transition) {\r\n\t\t\t\t\t\tlet approval_access = false;\r\n\t\t\t\t\t\tconst user = frappe.session.user;\r\n\t\t\t\t\t\tif (user === 'Administrator'\r\n\t\t\t\t\t\t\t|| transition.allow_self_approval\r\n\t\t\t\t\t\t\t|| user !== frm.doc.owner) {\r\n\t\t\t\t\t\t\tapproval_access = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn approval_access;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfrappe.workflow.get_transitions(frm.doc).then(transitions => {\r\n\t\t\t\t\t\tfrm.page.clear_actions_menu();\r\n\t\t\t\t\t\ttransitions.forEach(d => {\r\n\t\t\t\t\t\t\tif (frappe.user_roles.includes(d.allowed) && has_approval_access(d)) {\r\n\t\t\t\t\t\t\t\tfrm.page.add_action_item(__(d.action), function() {\r\n\t\t\t\t\t\t\t\t\tif(d.action.toLowerCase().includes(\"approve\") || d.action.toLowerCase().includes(\"cancel\") || d.action.toLowerCase().includes(\"submit\") || d.action.toLowerCase().includes(\"reject\")){\r\n\t\t\t\t\t\t\t\t\t\tfrappe.confirm(\r\n\t\t\t\t\t\t\t\t\t\t\t'Are you sure you want to \"' + d.action + '\" the document ' + frm.doc.name + '?',\r\n\t\t\t\t\t\t\t\t\t\t\tfunction(){\r\n\t\t\t\t\t\t\t\t\t\t\t\tfrappe.prompt([\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlabel: 'Enter narative for your decision to ' + d.action + '. Document: ' + frm.doc.name,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfieldtype: 'Small Text',\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\treqd: true,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfieldname: 'reason'\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}],\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tfunction(args){\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrm.timeline.insert_comment(\"Decision: \" + d.action + \" - Memo : \" + args.reason);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrm.selected_workflow_action = d.action;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrm.script_manager.trigger('before_workflow_action').then(() => {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrappe.xcall('frappe.model.workflow.apply_workflow', {doc: frm.doc, action: d.action}).then((doc) => {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrappe.model.sync(doc);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrm.refresh();\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrm.selected_workflow_action = null;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrm.script_manager.trigger(\"after_workflow_action\");\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t\t\tfunction(){\r\n\t\t\t\t\t\t\t\t\t\t\t\tvalidated = false;\r\n\t\t\t\t\t\t\t\t\t\t\t\twindow.close();\r\n\t\t\t\t\t\t\t\t\t\t\t\t//frappe.throw(\"No action taken. Go back to document\");\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\t\tfrm.selected_workflow_action = d.action;\r\n\t\t\t\t\t\t\t\t\t\tfrm.script_manager.trigger('before_workflow_action').then(() => {\r\n\t\t\t\t\t\t\t\t\t\t\tfrappe.xcall('frappe.model.workflow.apply_workflow', {doc: frm.doc, action: d.action}).then((doc) => {\r\n\t\t\t\t\t\t\t\t\t\t\t\tfrappe.model.sync(doc);\r\n\t\t\t\t\t\t\t\t\t\t\t\tfrm.refresh();\r\n\t\t\t\t\t\t\t\t\t\t\t\tfrm.selected_workflow_action = null;\r\n\t\t\t\t\t\t\t\t\t\t\t\tfrm.script_manager.trigger(\"after_workflow_action\");\r\n\t\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n                }\r\n            })\r\n \r\n\r\n        }\r\n    })\r\n}\r\n\r\n//1. SUBSCRIBE TO AN EVENT THAT TRIGGERS NEED FOR ONE TO INPUT A COMMENT.\r\nfrappe.realtime.on(\"doc_comment\", (data) => {\r\n\tfrappe.prompt([\r\n\t\t{\r\n\t\t\tlabel: 'Enter narative for your decision to ' + data.decision + '. Document: ' + doc.doc_name,\r\n\t\t\tfieldtype: 'Small Text',\r\n\t\t\treqd: true,\r\n\t\t\tfieldname: 'reason'\r\n\t\t}],\r\n\t\tfunction(args){\r\n\t\t\tconsole.log(\"Reason: \" + args.reason);\r\n\t\t\t//INSERT COMMENT.\r\n\t\t\td = frappe.get_doc(doc.doc_type, doc.doc_name);\r\n\t\t\td.add_comment('The document decision: ' + data.decision + \": \" + args.reason);\r\n\t\t}\r\n\t);\r\n})"],"names":["page_changed","event","frappe","after_ajax","route","get_route","ui","form","on","refresh","frm","doc","__unsaved","state_fieldname","workflow","get_state_fieldname","doctype","get_transitions","then","transitions","page","clear_actions_menu","forEach","d","transition","approval_access","user","user_roles","includes","allowed","session","allow_self_approval","owner","add_action_item","__","action","toLowerCase","confirm","name","prompt","label","fieldtype","reqd","fieldname","args","timeline","insert_comment","reason","selected_workflow_action","script_manager","trigger","xcall","model","sync","validated","window","close","$","realtime","data","decision","doc_name","console","log","get_doc","doc_type","add_comment"],"mappings":"yBAKA,SAASA,EAAaC,GAElBC,OAAOC,WAAW,WACd,IAAIC,EAAQF,OAAOG,YAEH,QAAZD,EAAM,IACNF,OAAOI,GAAGC,KAAKC,GAAGJ,EAAM,GAAI,CACxBK,QAAS,SAAUC,GAE9B,GAAwB,IAApBA,EAAIC,IAAIC,UAAZ,CAGA,IAAIC,EAAkBX,OAAOY,SAASC,oBAAoBL,EAAIM,SAWtDN,EAAIC,IAAIE,IAgBhBX,OAAOY,SAASG,gBAAgBP,EAAIC,KAAKO,cAAKC,GAC7CT,EAAIU,KAAKC,qBACTF,EAAYG,iBAAQC,GAZrB,IAA6BC,EACxBC,EACEC,EAWDxB,OAAOyB,WAAWC,SAASL,EAAEM,WAbNL,EAasCD,EAZ9DE,GAAkB,GAET,mBADPC,EAAOxB,OAAO4B,QAAQJ,OAExBF,EAAWO,qBACXL,IAAShB,EAAIC,IAAIqB,SACpBP,GAAkB,GAEZA,IAMLf,EAAIU,KAAKa,gBAAgBC,GAAGX,EAAEY,QAAS,WACnCZ,EAAEY,OAAOC,cAAcR,SAAS,YAAcL,EAAEY,OAAOC,cAAcR,SAAS,WAAaL,EAAEY,OAAOC,cAAcR,SAAS,WAAaL,EAAEY,OAAOC,cAAcR,SAAS,UAC1K1B,OAAOmC,QACN,6BAA+Bd,EAAEY,OAAS,kBAAoBzB,EAAIC,IAAI2B,KAAO,IAC7E,WACCpC,OAAOqC,OAAO,CACb,CACCC,MAAO,uCAAyCjB,EAAEY,OAAS,eAAiBzB,EAAIC,IAAI2B,KACpFG,UAAW,aACXC,MAAM,EACNC,UAAW,WAEZ,SAASC,GACRlC,EAAImC,SAASC,eAAe,aAAevB,EAAEY,OAAS,aAAeS,EAAKG,QAC1ErC,EAAIsC,yBAA2BzB,EAAEY,OACjCzB,EAAIuC,eAAeC,QAAQ,0BAA0BhC,gBACpDhB,OAAOiD,MAAM,uCAAwC,CAACxC,IAAKD,EAAIC,IAAKwB,OAAQZ,EAAEY,SAASjB,cAAMP,GAC5FT,OAAOkD,MAAMC,KAAK1C,GAClBD,EAAID,UACJC,EAAIsC,yBAA2B,KAC/BtC,EAAIuC,eAAeC,QAAQ,gCAOhC,WACCI,WAAY,EACZC,OAAOC,WAKT9C,EAAIsC,yBAA2BzB,EAAEY,OACjCzB,EAAIuC,eAAeC,QAAQ,0BAA0BhC,gBACpDhB,OAAOiD,MAAM,uCAAwC,CAACxC,IAAKD,EAAIC,IAAKwB,OAAQZ,EAAEY,SAASjB,cAAMP,GAC5FT,OAAOkD,MAAMC,KAAK1C,GAClBD,EAAID,UACJC,EAAIsC,yBAA2B,KAC/BtC,EAAIuC,eAAeC,QAAQ,0CAtFvCO,EAAEF,QAAQ/C,GAAG,aAAcR,GAC3ByD,EAAEF,QAAQ/C,GAAG,OAAQR,GAsGrBE,OAAOwD,SAASlD,GAAG,uBAAgBmD,GAClCzD,OAAOqC,OAAO,CACb,CACCC,MAAO,uCAAyCmB,EAAKC,SAAW,eAAiBjD,IAAIkD,SACrFpB,UAAW,aACXC,MAAM,EACNC,UAAW,WAEZ,SAASC,GACRkB,QAAQC,IAAI,WAAanB,EAAKG,QAE9BxB,EAAIrB,OAAO8D,QAAQrD,IAAIsD,SAAUtD,IAAIkD,UACrCtC,EAAE2C,YAAY,0BAA4BP,EAAKC,SAAW,KAAOhB,EAAKG"}