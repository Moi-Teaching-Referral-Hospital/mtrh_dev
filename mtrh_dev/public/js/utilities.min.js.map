{"version":3,"file":"utilities.min.js","sources":["../../../../apps/mtrh_dev/mtrh_dev/public/js/utilities.js"],"sourcesContent":["//FOR ALL MTRH DEV JAVASCRIPT UTILITIES\r\n// the following two handles will watch the page changes everywhere\r\n$(window).on('hashchange', page_changed);\r\n$(window).on('load', page_changed);\r\n//$(window).on('refresh', page_changed);\r\nfunction page_changed(event) {\r\n    // waiting for page to load completely\r\n    frappe.after_ajax(function () {\r\n\t\tvar route = frappe.get_route();\r\n\r\n        if (route[0] == \"Form\") {\r\n\t\t\tif (!cur_frm.is_new() && (route[1] !== undefined) && (route[2] !== undefined)) {\r\n\t\t\t\tconsole.log(\"1. \" + route[1] + \", 2: \" + route[2] + \", 3: \" + cur_frm.doc.name + \", 4: \" + cur_frm.doc.doctype)\r\n\t\t\t\t\r\n\t\t\t\tfrappe.call({\r\n\t\t\t\t\t\"method\":\"mtrh_dev.mtrh_dev.document_dashboard.document_dashboard\",\r\n\t\t\t\t\t\targs: {\r\n\t\t\t\t\t\t\t\"docname\": cur_frm.doc.name,\r\n\t\t\t\t\t\t\t\"doctype\": cur_frm.doc.doctype\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\"callback\":function(e){\r\n\t\t\t\t\t\tconsole.log(\"DASHBOARD: \" + e.message);\r\n\t\t\t\t\t\t//frm.dashboard.refresh();\r\n\t\t\t\t\t\t//setTimeout(() => {\r\n\t\t\t\t\t\t\t//$(\".form-dashboard-section.custom\").remove();\r\n\t\t\t\t\t\t\t//$(\"#divdash\").remove();\r\n\t\t\t\t\t\tcur_frm.dashboard.add_section(\"<div id='divdash'>\" + e.message + \"</div>\");\r\n\t\t\t\t\t\tcur_frm.dashboard.show();\r\n\t\t\t\t\t\t//}, 2000);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n            frappe.ui.form.on(route[1], {\r\n\t\t\t\tonload_post_render: function(frm){\r\n\t\t\t\t\t\r\n\t\t\t\t},\r\n                refresh: function (frm) {\r\n\t\t\t\t\t// if the loaded doc is dirty, don't show workflow buttons\r\n\t\t\t\t\tconsole.log(\"Beginning execution...\")\r\n\t\t\t\t\tif (frm.doc.__unsaved===1) {\r\n\t\t\t\t\t\tconsole.log(\"Is Dirty\")\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t//////\r\n\t\t\t\t\t//const { we_been_here } = localStorage;\r\n\t\t\t\t\tif (!frm.is_new()) {\r\n\t\t\t\t\t\t//console.log(\"REFRESH -> \" + we_been_here);\r\n\t\t\t\t\t\t//localStorage.setItem(\"we_been_here\", true);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//////\r\n\t\t\t\t\t\r\n\t\t\t\t\tvar state_fieldname = frappe.workflow.get_state_fieldname(frm.doctype);\r\n\t\t\t\t\tfunction set_default_state() {\r\n\t\t\t\t\t\tvar default_state = frappe.workflow.get_default_state(frm.doctype, frm.doc.docstatus);\r\n\t\t\t\t\t\tif(default_state) {\r\n\t\t\t\t\t\t\tfrm.set_value(state_fieldname, default_state);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfunction get_state() {\r\n\t\t\t\t\t\t//if(!frm.doc[state_fieldname]) {\r\n\t\t\t\t\t\t//\tset_default_state();\r\n\t\t\t\t\t\t//}\r\n\t\t\t\t\t\treturn frm.doc[state_fieldname];\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst state = get_state();\r\n\t\t\t\t\tif(!state) {\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfunction has_approval_access(transition) {\r\n\t\t\t\t\t\tlet approval_access = false;\r\n\t\t\t\t\t\tconst user = frappe.session.user;\r\n\t\t\t\t\t\tif (user === 'Administrator'\r\n\t\t\t\t\t\t\t|| transition.allow_self_approval\r\n\t\t\t\t\t\t\t|| user !== frm.doc.owner) {\r\n\t\t\t\t\t\t\tapproval_access = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn approval_access;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfrappe.workflow.get_transitions(frm.doc).then(transitions => {\r\n\t\t\t\t\t\tfrm.page.clear_actions_menu();\r\n\t\t\t\t\t\ttransitions.forEach(d => {\r\n\t\t\t\t\t\t\tif (frappe.user_roles.includes(d.allowed) && has_approval_access(d)) {\r\n\t\t\t\t\t\t\t\tfrm.page.add_action_item(__(d.action), function() {\r\n\t\t\t\t\t\t\t\t\tworkflowstate_includes_scm = false;\r\n\t\t\t\t\t\t\t\t\tif(frm.doc.workflow_state){\r\n\t\t\t\t\t\t\t\t\t\tworkflowstate_includes_scm = frm.doc.workflow_state.toLowerCase().includes(\"scm\");\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tif(workflowstate_includes_scm || d.action.toLowerCase().includes(\"confirm\") || d.action.toLowerCase().includes(\"approve\") || d.action.toLowerCase().includes(\"cancel\") || d.action.toLowerCase().includes(\"submit\") || d.action.toLowerCase().includes(\"reject\") || d.action.toLowerCase().includes(\"terminate\") || d.action.toLowerCase().includes(\"recall\") || d.action.toLowerCase().includes(\"confirm\") || d.action.toLowerCase().includes(\"send\")){\r\n\t\t\t\t\t\t\t\t\t\tfrappe.confirm(\r\n\t\t\t\t\t\t\t\t\t\t\t'Are you sure you want to \"' + d.action + '\" the document ' + frm.doc.name + '?',\r\n\t\t\t\t\t\t\t\t\t\t\tfunction(){\r\n\t\t\t\t\t\t\t\t\t\t\t\tfrappe.prompt([\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlabel: 'Enter narative for your decision to ' + d.action + '. Document: ' + frm.doc.name,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfieldtype: 'Small Text',\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\treqd: true,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfieldname: 'reason'\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}],\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tfunction(args){\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrm.timeline.insert_comment(\"Decision: \" + d.action + \" - Memo : \" + args.reason);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrm.selected_workflow_action = d.action;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrm.script_manager.trigger('before_workflow_action').then(() => {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrappe.xcall('frappe.model.workflow.apply_workflow', {doc: frm.doc, action: d.action}).then((doc) => {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrappe.model.sync(doc);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrm.refresh();\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrm.selected_workflow_action = null;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfrm.script_manager.trigger(\"after_workflow_action\");\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t\t\tfunction(){\r\n\t\t\t\t\t\t\t\t\t\t\t\tvalidated = false;\r\n\t\t\t\t\t\t\t\t\t\t\t\twindow.close();\r\n\t\t\t\t\t\t\t\t\t\t\t\t//frappe.throw(\"No action taken. Go back to document\");\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\t\t\t\tfrm.selected_workflow_action = d.action;\r\n\t\t\t\t\t\t\t\t\t\tfrm.script_manager.trigger('before_workflow_action').then(() => {\r\n\t\t\t\t\t\t\t\t\t\t\tfrappe.xcall('frappe.model.workflow.apply_workflow', {doc: frm.doc, action: d.action}).then((doc) => {\r\n\t\t\t\t\t\t\t\t\t\t\t\tfrappe.model.sync(doc);\r\n\t\t\t\t\t\t\t\t\t\t\t\tfrm.refresh();\r\n\t\t\t\t\t\t\t\t\t\t\t\tfrm.selected_workflow_action = null;\r\n\t\t\t\t\t\t\t\t\t\t\t\tfrm.script_manager.trigger(\"after_workflow_action\");\r\n\t\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n                }\r\n            })\r\n \r\n\r\n        }\r\n    })\r\n}\r\n\r\n//1. SUBSCRIBE TO AN EVENT THAT TRIGGERS NEED FOR ONE TO INPUT A COMMENT.\r\nfrappe.realtime.on(\"doc_comment\", (data) => {\r\n\tfrappe.prompt([\r\n\t\t{\r\n\t\t\tlabel: 'Enter narative for your decision to ' + data.decision + '. Document: ' + doc.doc_name,\r\n\t\t\tfieldtype: 'Small Text',\r\n\t\t\treqd: true,\r\n\t\t\tfieldname: 'reason'\r\n\t\t}],\r\n\t\tfunction(args){\r\n\t\t\tconsole.log(\"Reason: \" + args.reason);\r\n\t\t\t//INSERT COMMENT.\r\n\t\t\td = frappe.get_doc(doc.doc_type, doc.doc_name);\r\n\t\t\td.add_comment('The document decision: ' + data.decision + \": \" + args.reason);\r\n\t\t}\r\n\t);\r\n})"],"names":["page_changed","event","frappe","after_ajax","route","get_route","cur_frm","is_new","undefined","console","log","doc","name","doctype","call","method","args","docname","callback","e","message","dashboard","add_section","show","ui","form","on","onload_post_render","frm","refresh","__unsaved","state_fieldname","workflow","get_state_fieldname","get_transitions","then","transitions","page","clear_actions_menu","forEach","d","transition","approval_access","user","user_roles","includes","allowed","session","allow_self_approval","owner","add_action_item","__","action","workflowstate_includes_scm","workflow_state","toLowerCase","confirm","prompt","label","fieldtype","reqd","fieldname","timeline","insert_comment","reason","selected_workflow_action","script_manager","trigger","xcall","model","sync","validated","window","close","$","realtime","data","decision","doc_name","get_doc","doc_type","add_comment"],"mappings":"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"}